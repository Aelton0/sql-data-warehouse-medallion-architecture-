


/* ===========================
   CARREGARNDO A CAMADA SILVER
   ===========================*/
  
/*===========================
   CARREGARNDO ARQUIVOS CRM
  ===========================*/

CALL proc_load_silver;
  
DROP PROCEDURE IF EXISTS proc_load_silver;
DELIMITER $$
CREATE PROCEDURE proc_load_silver()
BEGIN
	-- Variaveis para duração
	DECLARE batch_start_time, start_time, end_time DATETIME;
    
	-- Tratativa de erros
	DECLARE status_error CHAR(5);
    DECLARE message VARCHAR(200);
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN 
		GET DIAGNOSTICS CONDITION 1
			status_error = RETURNED_SQLSTATE,
            message = MESSAGE_TEXT;
		SELECT CONCAT ('Status do Erro: ', status_error, 'Message: ', message) AS ErrorInfo;
		ROLLBACK;
    END;
    START TRANSACTION;
	-- Carregando silver silver_crm_cust_info
    SET batch_start_time = NOW();
	SET start_time = NOW();
	TRUNCATE TABLE silver_crm_cust_info;
    INSERT INTO silver_crm_cust_info (
		cst_id,
		cst_key,
		cst_firstname,
		cst_lastname,
		cst_marital_status,
		cst_gndr,
		cst_create_date)

	SELECT
	cst_id,
	TRIM(cst_key) AS cst_key,
	TRIM(cst_firstname) AS cst_firstname,
	TRIM(cst_lastname) AS cst_lastname,
		CASE 
			WHEN UPPER(TRIM(cst_marital_status)) ='S' 
					THEN 'Single'
			WHEN UPPER(TRIM(cst_marital_status)) ='M' 
					THEN 'Married'
			ELSE 'N/A'
		END AS cst_marital_status,
		COALESCE(
			CASE 
				WHEN UPPER(TRIM(cst_gndr)) IN ('F','M') 
					THEN UPPER(TRIM(cst_gndr)) 
			END, 'N/A') AS cst_gndr,
	cst_create_date
    
	FROM (
	SELECT *,
		ROW_NUMBER () OVER(PARTITION BY cst_id ORDER BY cst_create_date DESC) AS date_flag_last
		FROM bronze_crm_cust_info) AS derived
	WHERE date_flag_last =1;
    SET end_time = NOW();
    SELECT CONCAT('Load Duration: ', TIMESTAMPDIFF(SECOND ,start_time, end_time), ' seconds') AS Duration;
    
	COMMIT;
    
END $$
DELIMITER ;


-- 	SELECT cst_id, COUNT(*) AS 'Duplicatas'
-- 	FROM silver_crm_cust_info
-- 	GROUP BY cst_id
-- 	HAVING COUNT(*) > 1 OR cst_id IS NULL;

